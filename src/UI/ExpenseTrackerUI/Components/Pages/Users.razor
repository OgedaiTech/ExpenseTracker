@page "/users"
@attribute [Authorize(Roles = "SystemAdmin,TenantAdmin")]
@rendermode InteractiveServer

@using ExpenseTrackerUI.Services.User
@using ExpenseTrackerUI.Components.Shared
@inject UserService UserService

<h3>User Management</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateUserModal">
        <span class="bi bi-person-add"></span> New User
    </button>
    <button class="btn btn-secondary ms-2" @onclick="ShowBulkCreateModal">
        <span class="bi bi-upload"></span> Bulk Create
    </button>
</div>

@if (successMessage != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

<p class="text-muted">User listing coming soon...</p>

<CreateUserModal @ref="createUserModal" OnUserCreated="HandleUserCreated" />
<BulkCreateUsersModal @ref="bulkCreateModal" OnUploadCompleted="HandleBulkUploadCompleted" />

@code {
    private CreateUserModal? createUserModal;
    private BulkCreateUsersModal? bulkCreateModal;
    private string? successMessage;

    private async Task ShowCreateUserModal()
    {
        if (createUserModal != null)
        {
            await createUserModal.Show();
        }
    }

    private async Task ShowBulkCreateModal()
    {
        if (bulkCreateModal != null)
        {
            await bulkCreateModal.Show();
        }
    }

    private void HandleUserCreated(CreateUserWithInvitationResponse result)
    {
        if (result.InvitationSent)
        {
            successMessage = $"User {result.Email} created successfully. Invitation email sent.";
        }
        else
        {
            successMessage = $"User {result.Email} created successfully. Warning: Invitation email failed to send.";
        }
        StateHasChanged();
    }

    private void HandleBulkUploadCompleted(BulkCreateUsersResponse result)
    {
        successMessage = $"Bulk upload completed: {result.SuccessCount} created, " +
        $"{result.AlreadyExistedCount} already existed, " +
        $"{result.FailedCount} failed";
        StateHasChanged();
    }
}