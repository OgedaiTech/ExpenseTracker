@page "/"

<PageTitle>Home</PageTitle>

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ITokenStorageService TokenStorage
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using ExpenseTrackerUI.Services

<AuthorizeView>
    <Authorized>
        @code {
            private string? userName;
            protected override async Task OnInitializedAsync()
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                userName = user.Identity?.Name;
                
                // Check if tokens exist when user appears authenticated
                if (user.Identity?.IsAuthenticated == true)
                {
                    var accessToken = await TokenStorage.GetAccessTokenAsync();
                    if (string.IsNullOrEmpty(accessToken))
                    {
                        // User appears logged in but no tokens - sign them out
                        await TokenStorage.ClearTokensAsync();
                        await HttpContextAccessor.HttpContext!.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
                        Navigation.NavigateTo("/login", true);
                        return;
                    }
                }
            }
        }
        <h1>Welcome, @userName!</h1>
    </Authorized>
    <NotAuthorized>
        <h1>You are not logged in.</h1>
    </NotAuthorized>
</AuthorizeView>